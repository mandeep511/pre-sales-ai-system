// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  email     String   @unique
  name      String
  password  String
  role      String   @default("user")
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campaigns             Campaign[]
  campaignConfigVersions CampaignConfigVersion[]
  activityLogs          ActivityLog[]
}

model Campaign {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  status      String   @default("draft") // draft, active, paused, archived
  
  // AI Configuration
  systemPrompt String
  callGoal     String?
  voice        String   @default("alloy")
  
  // Dynamic configuration (JSON)
  postCallForm Json?
  tools        Json?
  
  // Queue settings
  batchSize   Int      @default(10)
  callGap     Int      @default(30)
  maxRetries  Int      @default(3)
  priority    Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String   @db.ObjectId
  
  createdBy      User                      @relation(fields: [createdById], references: [id])
  leads          Lead[]
  callSessions   CallSession[]
  configVersions CampaignConfigVersion[]
  queueState     QueueState?
}

model Lead {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  campaignId String?  @db.ObjectId
  
  // Contact info
  name       String
  phone      String   @unique
  email      String?
  company    String?
  
  // Lead data (JSON stored as string)
  metadata   String   @default("{}")
  tags       String   @default("[]")
  
  // Status tracking
  status     String   @default("new") // new, contacted, qualified, unqualified, failed
  priority   Int      @default(0)
  attempts   Int      @default(0)
  lastCalledAt DateTime?
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  campaign     Campaign?    @relation(fields: [campaignId], references: [id])
  callSessions CallSession[]
}

model CallSession {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  campaignId String   @db.ObjectId
  leadId     String   @db.ObjectId
  direction  String?
  
  // Call details
  status     String   @default("pending") // pending, in_progress, completed, failed
  startedAt  DateTime?
  endedAt    DateTime?
  duration   Int?
  
  // Results
  summary    String?
  outcome    String?
  configSnapshot Json?
  formData   String?
  
  // Technical
  twilioCallSid   String?  @unique
  twilioStreamSid String?
  fromNumber      String?
  toNumber        String?
  queuedAt        DateTime @default(now())
  dialedAt        DateTime?
  answeredAt      DateTime?
  error           String?
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  campaign Campaign @relation(fields: [campaignId], references: [id])
  lead     Lead     @relation(fields: [leadId], references: [id])
  transcript Transcript?
  recording  Recording?
}

model QueueState {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  campaignId      String   @unique @db.ObjectId
  campaign        Campaign @relation(fields: [campaignId], references: [id])
  status          String   @default("idle")
  currentBatch    Json?
  batchStartedAt  DateTime?
  nextScheduledAt DateTime?
  totalQueued     Int      @default(0)
  totalCompleted  Int      @default(0)
  totalFailed     Int      @default(0)
  updatedAt       DateTime @updatedAt
}

model CampaignConfigVersion {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  campaignId  String   @db.ObjectId
  version     Int
  
  // Config snapshot (JSON)
  snapshot   String
  
  // Metadata
  changes    String?
  createdAt  DateTime @default(now())
  createdById String  @db.ObjectId
  
  campaign  Campaign @relation(fields: [campaignId], references: [id])
  createdBy User     @relation(fields: [createdById], references: [id])
  
  @@unique([campaignId, version])
}

model Transcript {
  id            String      @id @default(auto()) @map("_id") @db.ObjectId
  callSessionId String      @unique @db.ObjectId
  callSession   CallSession @relation(fields: [callSessionId], references: [id])
  items         Json
  toolCalls     Json?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
}

model Recording {
  id            String      @id @default(auto()) @map("_id") @db.ObjectId
  callSessionId String      @unique @db.ObjectId
  callSession   CallSession @relation(fields: [callSessionId], references: [id])
  audioUrl      String?
  format        String?
  createdAt     DateTime    @default(now())
}

model ActivityLog {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  userId     String   @db.ObjectId
  action     String
  entityType String
  entityId   String?  @db.ObjectId
  details    String?
  createdAt  DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id])
  
  @@index([entityType, entityId])
  @@index([userId])
}
