// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  email     String   @unique
  name      String
  password  String
  role      String   @default("user")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campaigns             Campaign[]
  campaignConfigVersions CampaignConfigVersion[]
  activityLogs          ActivityLog[]
}

model Campaign {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  status      String   @default("draft") // draft, active, paused, archived
  
  // AI Configuration
  systemPrompt String
  callGoal     String?
  voice        String   @default("alloy")
  
  // Dynamic configuration (JSON)
  postCallForm String   @default("[]")
  tools        String   @default("[]")
  
  // Queue settings
  batchSize   Int      @default(10)
  callGap     Int      @default(30)
  maxRetries  Int      @default(3)
  priority    Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String   @db.ObjectId
  
  createdBy      User                      @relation(fields: [createdById], references: [id])
  leads          Lead[]
  callSessions   CallSession[]
  configVersions CampaignConfigVersion[]
}

model Lead {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  campaignId String?  @db.ObjectId
  
  // Contact info
  name       String
  phone      String   @unique
  email      String?
  company    String?
  
  // Lead data (JSON stored as string)
  metadata   String   @default("{}")
  tags       String   @default("[]")
  
  // Status tracking
  status     String   @default("new") // new, contacted, qualified, unqualified, failed
  priority   Int      @default(0)
  attempts   Int      @default(0)
  lastCallAt DateTime?
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  campaign     Campaign?    @relation(fields: [campaignId], references: [id])
  callSessions CallSession[]
}

model CallSession {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  campaignId String   @db.ObjectId
  leadId     String   @db.ObjectId
  
  // Call details
  status     String   @default("pending") // pending, in_progress, completed, failed
  startedAt  DateTime?
  endedAt    DateTime?
  duration   Int?
  
  // Results
  transcript String?
  summary    String?
  outcome    String?
  formData   String?
  
  // Technical
  callSid    String?
  error      String?
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  campaign Campaign @relation(fields: [campaignId], references: [id])
  lead     Lead     @relation(fields: [leadId], references: [id])
}

model CampaignConfigVersion {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  campaignId  String   @db.ObjectId
  version     Int
  
  // Config snapshot (JSON)
  snapshot   String
  
  // Metadata
  changes    String?
  createdAt  DateTime @default(now())
  createdById String  @db.ObjectId
  
  campaign  Campaign @relation(fields: [campaignId], references: [id])
  createdBy User     @relation(fields: [createdById], references: [id])
  
  @@unique([campaignId, version])
}

model ActivityLog {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  userId     String   @db.ObjectId
  action     String
  entityType String
  entityId   String
  details    String?
  createdAt  DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id])
  
  @@index([entityType, entityId])
  @@index([userId])
}
